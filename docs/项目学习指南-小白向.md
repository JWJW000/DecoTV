# DecoTV 项目学习指南（小白向）

用直白的话说明：这个项目是啥、用了啥技术、代码怎么组织、从哪里开始看。

---

## 一、这个项目是干什么的？

**一句话**：一个「影视聚合网站」—— 你输入片名，它去多个资源站帮你搜，搜到后可以在网页里直接看，还能记播放进度、收藏、弹幕等。

**类比**：有点像「一个自己部署的小型点播站」：没有内置片源，需要站长在后台配置「从哪些网站拉数据」，用户来你这里搜索、点播、看弹幕。

所以项目里会涉及：
- **搜**：关键词 → 调用多个资源站 API → 合并结果
- **播**：选一集 → 拿到视频地址（m3u8 等）→ 用网页播放器播放
- **记**：播放进度、收藏、跳过片头片尾等要存起来（浏览器本地或 Redis）
- **管**：站长在 `/admin` 里配置资源站、直播源、用户、弹幕源等

---

## 二、用到的技术（用大白话解释）

| 名词 | 大白话 |
|------|--------|
| **Next.js** | 一个用 React 写网页的框架，特点是「前后端在一起」：既能写页面，也能在同一个项目里写接口（API）。 |
| **React** | 用「组件」的方式做页面，一个按钮、一张卡片、一整页都可以是一个组件，方便复用和维护。 |
| **TypeScript** | 在 JavaScript 上加「类型」，写的时候就知道变量是字符串还是数字，减少低级错误。 |
| **Tailwind CSS** | 用类名来写样式（如 `text-red-500`、`flex`），不用单独写很多 CSS 文件。 |
| **App Router** | Next.js 的「按文件夹定路由」方式：`src/app/search/page.tsx` 就对应网址 `/search`。 |
| **API 路由** | 在 `src/app/api/xxx/route.ts` 里写「接口」：浏览器请求 `/api/search`，就执行这个文件里的逻辑（比如去调资源站、查数据库）。 |

**记这三点就够入门**：
1. **页面**：`src/app/某个路径/page.tsx` = 你访问的这个路径的界面。
2. **接口**：`src/app/api/某个路径/route.ts` = 前端调用的「后端逻辑」。
3. **组件 / 工具**：`src/components/`、`src/lib/`、`src/hooks/` = 被页面和接口共用的东西。

---

## 三、目录结构（先记这几块）

```
DecoTV/
├── src/
│   ├── app/                    ← 「页面」+ 「接口」都在这里
│   │   ├── page.tsx            ← 首页 /
│   │   ├── search/page.tsx     ← 搜索页 /search
│   │   ├── play/page.tsx       ← 播放页 /play
│   │   ├── login/page.tsx      ← 登录页
│   │   ├── admin/page.tsx      ← 管理后台（很大，配置源、用户等）
│   │   ├── live/page.tsx       ← 直播
│   │   ├── api/                ← 所有「后端接口」
│   │   │   ├── search/route.ts     ← 搜索接口
│   │   │   ├── login/route.ts      ← 登录接口
│   │   │   ├── playrecords/...     ← 播放记录
│   │   │   ├── favorites/...       ← 收藏
│   │   │   ├── proxy/...           ← 代理（解决跨域、转发视频流等）
│   │   │   └── ...
│   │   ├── layout.tsx          ← 全局外壳（导航、主题等）
│   │   └── globals.css         ← 全局样式
│   │
│   ├── components/             ← 可复用的 UI 组件（按钮、卡片、播放器等）
│   ├── lib/                    ← 核心逻辑与工具（数据库、配置、请求封装）
│   ├── hooks/                  ← 自定义 React Hooks（弹幕、投屏、豆瓣信息等）
│   ├── contexts/               ← React 全局状态（下载任务、首页缓存等）
│   ├── types/                  ← TypeScript 类型定义
│   └── proxy.ts                ← 请求拦截：谁要登录、谁要跳转 /warning 等
│
├── public/                     ← 静态资源（图片、图标、PWA 等）
├── .env.local                  ← 本地环境变量（如 PASSWORD）
├── package.json                ← 依赖和脚本（pnpm install / pnpm dev）
└── next.config.js              ← Next.js 配置
```

**先记住**：
- 想改「某个页面长什么样」→ 去 `app/对应路径/page.tsx`。
- 想改「搜索/登录/播放记录是怎么实现的」→ 去 `app/api/对应名字/route.ts`。
- 想改「数据库/配置/通用函数」→ 去 `lib/`。

---

## 四、一次「搜索 → 播放」会经过哪些文件？

帮助你把「用户操作」和「代码」对上号。

1. **用户打开首页**  
   - 看到的是：`src/app/page.tsx`（首页组件）  
   - 可能还会用到：`layout.tsx`、`components/PageLayout.tsx`、`contexts/GlobalCacheContext.tsx`（首页数据缓存）

2. **用户在搜索框输入并搜索**  
   - 页面：`src/app/search/page.tsx`  
   - 请求的接口：`src/app/api/search/route.ts`（这里会去调各个资源站，合并结果）

3. **用户点某一集进入播放页**  
   - 页面：`src/app/play/page.tsx`（很大，播放器、选集、收藏、弹幕、下载等都在这里）  
   - 拿详情：`/api/detail` → `src/app/api/detail/route.ts`  
   - 拿播放地址 / 代理：`src/app/api/proxy/stream/`、`proxy/m3u8/` 等

4. **播放进度、收藏要存下来**  
   - 前端调用：`src/lib/db.client.ts`（对浏览器暴露的「存/取」接口）  
   - 后端真正存：`src/lib/db.ts`（根据环境选内存 / Redis / Upstash / Kvrocks）

5. **一打开网站就跳到登录或 /warning**  
   - 逻辑在：`src/proxy.ts`（检查有没有 PASSWORD、有没有登录 Cookie，没有就重定向）

所以：**改搜索逻辑看 api/search，改播放页看 app/play/page.tsx，改「存哪里」看 lib/db.ts。**

---

## 五、几个核心文件是干什么的（便于你按需深挖）

| 文件 | 作用（直白说） |
|------|----------------|
| `src/proxy.ts` | 每个请求进来先过这里：没配密码 → 去 /warning；没登录 → 去 /login；否则放行。 |
| `src/lib/db.ts` | 「存数据」的总入口：播放记录、收藏、用户、配置等，根据环境变量决定用内存还是 Redis/Upstash/Kvrocks。 |
| `src/lib/config.ts` | 站点配置、资源站列表、直播源等从「数据库/本地」读出来，供全站用；带缓存。 |
| `src/app/api/search/route.ts` | 搜索：收关键词，调多个资源站 API，合并、排序后返回。 |
| `src/app/play/page.tsx` | 播放页：播放器、选集、收藏、弹幕、下载、跳过片头片尾等，都在这一页里组织。 |
| `src/app/api/login/route.ts` | 登录：校验用户名密码（或仅密码），通过就写 Cookie，后续 proxy 靠 Cookie 放行。 |
| `src/app/api/proxy/*` | 代理：帮前端去拿第三方接口、m3u8、流地址等，解决跨域和 Mixed Content。 |

---

## 六、建议的学习顺序（按你时间挑着看）

1. **先跑起来**  
   - 配置 `.env.local` 的 `PASSWORD`，`pnpm dev`，在浏览器里点一圈：首页 → 搜索 → 播放 → 收藏。

2. **再看「一个请求怎么走」**  
   - 打开 `src/proxy.ts`，看「先判断密码、再判断登录、再 next()」。  
   - 打开 `src/app/api/login/route.ts`，看「读 body 里的密码，和环境变量比，对了就 set Cookie」。

3. **然后看「一个页面怎么组成」**  
   - 打开 `src/app/page.tsx`（首页），看它用了哪些组件（如 `ScrollableRow`、`VideoCard`）、从哪里拿数据（如 `useGlobalCache`）。  
   - 再打开 `src/app/search/page.tsx`，看它怎么调 `/api/search`、怎么展示结果。

4. **再看「数据存哪」**  
   - 打开 `src/lib/db.ts`，看 `STORAGE_TYPE` 和 `createStorage()`（内存 / redis / upstash / kvrocks）。  
   - 打开 `src/lib/db.client.ts`，看前端调用的 `savePlayRecord`、`getAllFavorites` 等是怎么和后端配合的。

5. **最后按功能啃大块**  
   - 弹幕：`hooks/useDanmu.ts` + `api/danmu-external/route.ts`  
   - 播放页：`app/play/page.tsx`（可配合「搜索 → 播放」那一段对照看）  
   - 管理后台：`app/admin/page.tsx`（体量大，可以只挑「资源站配置」或「用户管理」一块看）

---

## 七、常见概念对应（防止看代码时懵）

- **前端**：在浏览器里跑的，主要是 `app/**/page.tsx` + `components/`，负责界面和发请求。  
- **后端 / 接口**：在服务器跑的，`app/api/**/route.ts`，负责查数据、调第三方、写库。  
- **环境变量**：`.env.local` 里的 `PASSWORD`、`NEXT_PUBLIC_STORAGE_TYPE` 等，改完要重启 `pnpm dev`。  
- **Cookie auth**：登录成功后会在 Cookie 里写一个 `auth`，下次请求时 `proxy.ts` 读这个决定是否放行。  
- **localstorage 模式**：不连 Redis，数据只存在浏览器本地，适合单机体验；存到「库」里的功能会走内存实现（见 `lib/memory.db.ts`）。

---

如果你愿意，下一步可以指定一个功能（比如「只想搞懂搜索」或「只想搞懂登录」），我可以按「从点到哪、点到哪」给你列一份更细的「跟读清单」。
